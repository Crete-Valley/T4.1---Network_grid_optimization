# DPS-SERVER
### HTTP api for dpsim basic usage and pandapower optimal powerflow

# Table Of Contents
<!-- TOC start (generated with https://github.com/derlin/bitdowntoc) -->

- [Usage](#usage)
   * [ENV](#env)
   * [Docker](#docker)
   * [Helm](#helm)
   * [Open API spec](#open-api-spec)
   * [DPSIM Usage](#dpsim-usage)
   * [Pandapower Usage](#pandapower-usage)
- [API Reference](#-api-reference)
   * [Time Series Profile (JSON)](#-time-series-profile-json)
   * [Simulation Endpoint](#-simulation-endpoint)
   * [XML (CIM Archive) Endpoints](#-xml-cim-archive-endpoints)
   * [Time Series File Endpoints (Legacy/Deprecated)](#-time-series-file-endpoints-legacydeprecated)
   * [Schema Definitions (Models)](#-schema-definitions-models)
- [Frontend Integration Guide](#-integration-guide)

<!-- TOC end -->
<!-- TOC --><a name="usage"></a>
# Usage
<!-- TOC --><a name="env"></a>
## ENV
- `DPS_LOG_LEVEL` : all the log levels supported by the python logging module
<!-- TOC --><a name="docker"></a>
## Docker
Run docker image `registry.git.rwth-aachen.de/acs/public/dpsv:latest`:
`docker run -p 5000:5000 registry.git.rwth-aachen.de/acs/public/dpsv:latest`
Then send your requests to localhost:5000.<br>
Optionally mount a db folder instead of using http, then use the container cli,
container mount path has to correspond to the DPS_ROOT variable.<br>
`docker run --name dpsv -v $(pwd)/db:/dpsroot registry.git.rwth-aachen.de/acs/public/dpsv:latest`.<br>
You can then put your needed files (xml,profiles) directly in the corresponding db subfolder,and use the cli:
`docker exec dpsv sh -c 'dps run -ux <xml> -up <profile>...etc'`
In this manner, results are retrieved from `<db folder>/result/<sim name>`.<br>

<!-- TOC --><a name="helm"></a>
## Helm
To install chart locally on a kubernetes cluster, run 
`helm install dpsv ./helm-dpsv --namespace dpsv --create-namespace`
From the root folder. Change persist to true in values, to persist the timeseries/results database 
Server has no authentication, hiding it behind a proxy+ IDP is a good idea.<br>

<!-- TOC --><a name="open-api-spec"></a>
## Open API spec
Generated by fastapi at `/docs` endpoint, see [here](https://fastapi.tiangolo.com/#interactive-api-docs) to learn more.<br>

<!-- TOC --><a name="dpsim-usage"></a>
## DPSIM Usage
DPSIM repo is found [here](https://github.com/sogno-platform/dpsim).
This server mirrors some functionality of dpsim, more can be found in the [docs](https://dpsim.fein-aachen.org/docs/).<br>

<!-- TOC --><a name="pandapower-usage"></a>
## Pandapower Usage
This server provides [the optimal powerflow implemented by pandapower](https://github.com/e2nIEE/pandapower/blob/develop/tutorials/pandamodels_opf.ipynb).<br>

This functionality is "TODO" and not fully implemented yet.<br>
<!-- TOC --><a name="-api-reference"></a>
# API Reference

This document provides a reference for the available endpoints and data models in the system.

---

<!-- TOC --><a name="-time-series-profile-json"></a>
## Time Series Profile (JSON)

These endpoints handle uploading and retrieving time series data in a **JSON** format.

| Method | Path | Summary | Description |
| :--- | :--- | :--- | :--- |
| **`POST`** | `/jts/profile/{tsname}` | **Post Jts** | Upload a profile time series JSON. |
| **`GET`** | `/jts/result/{tsname}` | **Get Jts** | Get a result time series as JSON. |

<!-- TOC --><a name="post-jtsprofiletsname"></a>
#### **`POST` /jts/profile/{tsname}**
* **Description:** Upload a profile time series JSON.
* **Path Parameter:**
    * `tsname` (`string`, **required**): The name of the time series being uploaded.
* **Request Body:** An array of `TableRow` objects (JSON).
* **Successful Response (200):** `UploadFileResult` (e.g., `{"filename": "sim-run-1"}`)

<!-- TOC --><a name="get-jtsresulttsname"></a>
#### **`GET` /jts/result/{tsname}**
* **Description:** Get a result time series as JSON.
* **Path Parameter:**
    * `tsname` (`string`, **required**): Name of time series to fetch.
* **Successful Response (200):** `JsonTimeseriesResult`

---

<!-- TOC --><a name="-simulation-endpoint"></a>
## Simulation Endpoint

This endpoint initiates a simulation run.

| Method | Path | Summary | Description |
| :--- | :--- | :--- | :--- |
| **`POST`** | `/s` | **Run Sim** | Run a simulation. |

<!-- TOC --><a name="post-s"></a>
#### **`POST` /s**
* **Description:** Run a simulation.
* **Request Body:** `SimParameters` object (JSON) containing configuration for the simulation.
* **Successful Response (200):** `UploadFileResult` (e.g., `{"filename": "sim-run-1"}`)

---

<!-- TOC --><a name="-xml-cim-archive-endpoints"></a>
## XML (CIM Archive) Endpoints

These endpoints manage the uploading, listing, and deletion of **CIM data archives** (XML/ZIP).

| Method | Path | Summary | Description |
| :--- | :--- | :--- | :--- |
| **`GET`** | `/xml` | **List Xml** | List all CIM archive names. |
| **`POST`** | `/xml` | **Post Xml** | Post CIM data archive (multipart/form-data). |
| **`DELETE`** | `/xml/{xmlname}` | **Delete Xml** | Delete a system's CIM archive. |

<!-- TOC --><a name="post-xml"></a>
#### **`POST` /xml**
* **Description:** Post CIM data archive.
* **Request Body:** `multipart/form-data` with a `file` field (zip archive containing CIM xml profiles).
* **Successful Response (200):** `UploadFileResult`

<!-- TOC --><a name="get-xml"></a>
#### **`GET` /xml**
* **Description:** List all CIM archive names.
* **Successful Response (200):** `ListResult`

<!-- TOC --><a name="delete-xmlxmlname"></a>
#### **`DELETE` /xml/{xmlname}**
* **Description:** Delete a system's CIM archive.
* **Path Parameter:**
    * `xmlname` (`string`, **required**): Name of the archive to delete.
* **Successful Response (200):** `UploadFileResult`

---

<!-- TOC --><a name="-time-series-file-endpoints-legacydeprecated"></a>
## Time Series File Endpoints (Legacy/Deprecated)

These endpoints handle time series data as files.

| Method | Path | Summary | Description |
| :--- | :--- | :--- | :--- |
| **`POST`** | `/ts/profile` | **Post Ts** | Upload a profile time series file (multipart/form-data). **(Deprecated)** |
| **`GET`** | `/ts/{tstype}` | **List Ts** | List time series data of a certain resource. |
| **`DELETE`** | `/ts/{tstype}/{tsname}` | **Delete Ts** | Delete a time series from the file database. **(Deprecated)** |

<!-- TOC --><a name="get-tststype"></a>
#### **`GET` /ts/{tstype}**
* **Description:** List time series data of a certain resource.
* **Path Parameter:**
    * `tstype` (`string`, **required**): The type of the time series being fetched, one of **`profile`** or **`result`**.
* **Successful Response (200):** `ListResult`

---

<!-- TOC --><a name="-schema-definitions-models"></a>
## Schema Definitions (Models)

The following models define the structure of data used in the requests and responses.

<!-- TOC --><a name="simparameters"></a>
#### `SimParameters`
Parameters required to run a simulation.

| Property | Type | Description | Default | Example |
| :--- | :--- | :--- | :--- | :--- |
| **`name`** | `string` | Name of the simulation/produced result file. | `a9dd9b425335` | `sim-run-1` |
| **`freq`** | `integer` | Frequency of power grid. | `50` | `50` |
| **`duration`** | `integer` | Duration of simulation in timesteps. | `300` | `300` |
| **`timestep`** | `number` | Timestep of simulation. | `1` | `1` |
| **`opf`** | `boolean` | Generate a profile from a pandapower optimal powerflow. | `false` | `false` |
| **`use_profile`** | `string` or `null` | Use uploaded profile data, by keyword. | `null` | |
| **`replace_map`** | `object` or `null` | Replace component name parts to reconcile profiles and simulation. | `null` | `{"sym": "machine"}` |
| **`use_xml`** | `string` | CIM data to describe simulated system, by keyword. | | `cim-data-1` |
| **`domain`** | `string` | Domain of simulation (**SP** for Steady-state Power, etc.). | `SP` | `SP` |
| **`solver`** | `string` | Simulation solver type. | `NRP` | `NRP` |

<!-- TOC --><a name="tablerow"></a>
#### `TableRow`
Represents a single measurement or data point in a time series profile.

| Property | Type | Description | Required | Example |
| :--- | :--- | :--- | :--- | :--- |
| **`ts`** | `integer` | **Timestamp** of given measurement in **unix timestamp** format. | Yes | `1764627480` |
| **`value`** | `number` | Measured value. | Yes | `0.1` |
| **`profile_type`** | `string` | What the measured value represents (e.g., active power). | Yes | `SOME_LINE_COMPONENT` |
| **`power_type`** | `string` | Active or reactive, not strict, can contain 'active' or 'reactive' as substring. | Yes | `active` |
| `[extra_fields]` | Any | All extra fields are used as a label (e.g., `bus`, `line`). | No | `{"bus": "SOME_BUS_NAME"}` |

<!-- TOC --><a name="jsontimeseries"></a>
#### `JsonTimeseries`
A full time series structure, used for results.

| Property | Type | Description | Required | Example |
| :--- | :--- | :--- | :--- | :--- |
| **`time`** | `array` of `integer` | **Required.** A list of time values, one of integer timesteps or unix timestamps. | Yes | `[0.0, 0.5, 1.0, 1.5, 2.0]` |
| `[series_name]` | `array` of `number` | Keys map to time series names (e.g., sensor\_x), values are the measurement list. | No | `{"sensor_x": [10.1, 10.2, 10.3, 10.4, 10.5]}` |

<!-- TOC --><a name="uploadfileresult"></a>
#### `UploadFileResult`
Standard response model after a successful file upload or deletion.

| Property | Type | Description | Example |
| :--- | :--- | :--- | :--- |
| **`filename`** | `string` | Named resource result: filename, simulation name, profile/result name. | `sim-run-1` |

<!-- TOC --><a name="listresult"></a>
#### `ListResult`
Standard response model for listing resource names.

| Property | Type | Description | Example |
| :--- | :--- | :--- | :--- |
| **`lst`** | `array` of `string` | String list result. | `["cim-data-1", "cim-data-2"]` |

<!-- TOC --><a name="other-models"></a>
#### Other Models

* **`JsonTimeseriesResult`**: Contains the full `JsonTimeseries` object under the key `result`.
* **`HTTPValidationError`**: Standard FastAPI model for validation errors.
* **`ValidationError`**: Details of a validation error.
* **`Body_post_xml_xml_post`**: Multipart model for posting XML files.
* **`Body_post_ts_ts_profile_post`**: Multipart model for posting TS profile files.

---

<!-- TOC --><a name="-integration-guide"></a>
# DPSim Server API Integration Guide

This part outlines the workflow for integrating the **DPSim Server** into a web-based ecosystem. It covers grid data provision (CIM), profile management, simulation execution, and result retrieval using JavaScript.

This assume dpsim has been deployed with the tool of your choice, and is accessible to the frontend over the network.


## 1. System Architecture
The DPSim server operates as a RESTful service. The typical workflow follows a "Data-First" approach:

1.  **CIM Data Provision:** Upload grid topology via XML/ZIP.
2.  **Profile Provision:** Upload time-series data (Active/Reactive power).
3.  **Simulation Execution:** Trigger the solver with specific parameters.
4.  **Data Retrieval:** Fetch results for frontend visualization.


## 2. API Constants & Endpoints

Configuration

```javascript
const SERVER_URL = "http://localhost:5000";

const Endpoints = {
    UPLOAD_CIM: { path: "xml", method: "POST" },
    LIST_CIM: { path: "xml", method: "GET" },
    UPLOAD_PROFILE: { path: "jts/profile", method: "POST" },
    START_SIM: { path: "s", method: "POST" },
    GET_RESULT: { path: "jts/result", method: "GET" }
};
```
## 3. Core Implementation

### A. Uploading Grid Data (CIM XML)

CIM data must be sent as a multipart form-data archive (ZIP).

```javascript
async function uploadCimArchive(file) {
    const formData = new FormData();
    formData.append('file', file); // 'file' is the key expected by the server

    const response = await fetch(`${SERVER_URL}/${Endpoints.UPLOAD_CIM.path}`, {
        method: Endpoints.UPLOAD_CIM.method,
        body: formData
    });
    
    return await response.json();
}
```

### B. Providing Load Profiles

Profiles are sent as JSON arrays containing timestamps and power values.

```javascript
async function uploadProfile(profileName, dataPoints) {
    /*
    dataPoints should be an array of:
    {
        ts: number,           // Unix timestamp
        value: number,        // Power value
        profile_type: string, // Component name
        power_type: string    // e.g., "active" or "reactive"
    }
    */
    const response = await fetch(`${SERVER_URL}/${Endpoints.UPLOAD_PROFILE.path}/${profileName}`, {
        method: Endpoints.UPLOAD_PROFILE.method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(dataPoints)
    });
    
    return await response.json();
}
```

### C. Running a Simulation

Trigger the simulation by referencing the keywords used during the upload phase.

```javascript
async function runSimulation(simName, xmlKeyword, profileKeyword = null) {
    const payload = {
        name: simName,
        use_xml: xmlKeyword,
        use_profile: profileKeyword,
        duration: 300,
        timestep: 1,
        freq: 50,
        solver: "NRP",
        domain: "SP"
    };

    const response = await fetch(`${SERVER_URL}/${Endpoints.START_SIM.path}`, {
        method: Endpoints.START_SIM.method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    });
    
    return await response.json();
}
```

### D. Retrieving and Visualizing Results

Results are returned as a dictionary of time-series. In a frontend context, you would typically map these to a charting library like Chart.js or D3.js.
Result dictionary keys contain: Component name + _Observable letter (V, I, P or Q) + _Other labels , 

```javascript
async function fetchAndProcessResults(simName) {
    const response = await fetch(`${SERVER_URL}/${Endpoints.GET_RESULT.path}/${simName}`);
    const data = await response.json();
    const results = data.result;

    // Example: Calculate Magnitude for a specific component
    const timestamps = results.time;
    const componentRe = results['NAME_LABELS_<V|I|P|Q>.re'];
    const componentIm = results['NAME_LABELS_<V|I|P|Q>.im'];

    const magnitudes = componentRe.map((re, i) => {
        return Math.sqrt(Math.pow(re, 2) + Math.pow(componentIm[i], 2));
    });

    return { timestamps, magnitudes };
}
```
## 4. Data Models Reference

### Simulation Parameters Object
This object defines the configuration for the DPSim solver. It is sent as the JSON payload when triggering a simulation.

| Property | Type | Description |
| :--- | :--- | :--- |
| `name` | `string` | The unique identifier for the simulation. Results will be saved under this name. |
| `use_xml` | `string` | A keyword used to identify which uploaded CIM archive to use for the topology. |
| `use_profile` | `string` (opt) | A keyword used to identify which uploaded time-series profile to apply to loads. |
| `duration` | `number` | The total length of the simulation in seconds. |
| `timestep` | `number` | The time step size for the solver. |
| `solver` | `string` | The solver engine to use. |
| `domain` | `string` | The simulation domain. |


### Result Response
The server returns a JsonTimeseries object. Note that electrical values are decomposed into real (.re) and imaginary (.im) components.

```json
{
  "result": {
    "time": [1700000000, 1700000060, 1700000120],
    "BUS1.re": [1.0, 0.98, 0.99],
    "BUS1.im": [0.0, 0.01, -0.01],
    "LNE_A.re": [45.2, 46.1, 45.8],
    "LNE_A.im": [2.1, 2.3, 2.2]
  }
}
```
